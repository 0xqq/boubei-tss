


<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>业务部门审核</title>

    <link rel="stylesheet" href="../../tools/tssJS/css/boubei.css">
    <link rel="stylesheet" href="../../css/easyui.css">
    <link rel="stylesheet" href="../../tools/easyui/themes/default/easyui.css">
    <link rel="stylesheet" href="../../tools/easyui/themes/icon.css">

    <script src="../../tools/tssJS/tssJS.all.js"></script>
    <script src="../../tools/easyui/jquery.min.js"></script>
    <script src="../../tools/easyui/jquery.easyui.min.js"></script>
    <script src="../../tools/easyui/easyui-lang-zh_CN.js"></script>
    <script src="../../tools/easyui.js"></script>
    <style type="text/css">
    #tb>div:nth-child(2)>a{
        width:150px;
    }
    </style>

    <script type="text/javascript">
        // var tableId = 't1';
        // var tableName = 'queryData';
        // var toolbar = '#toolbar1';
        var recordId = 't_bill';
        // var dg,dg2;
        var user_defined_combobox=[
            {id:'busi_type',data:[{name:'单边'},{name:'双边'}]},
            {id:'status',data:[{name:'待支付'},{name:'已支付'},{name:'已退回'}]},
            {id:'account_period',data:[{name:'30'},{name:'60'},{name:'90'}]},
            {id:'bl_account_period',data:[{name:'7'},{name:'15'},{name:'30'},{name:'60'},{name:'90'}]},
            // {id:'type',data:[{data:'ETC'},{name:'油卡'},{name:'集中加油'},{name:"ETC保理"},{name:'油卡保理'}]}
            ];
        var reportName='finBusiApprove';
        var column = [
            {field: 'ck', checkbox: true},
            {field: 'plate_num', title: '车牌号', width: '10%', align: 'center'},
            {field: 'bill_date', title: '账单时间', width: '10%', align: 'center'},
            {field: 'start_date', title: '计费时间从', width: '10%', align: 'center'},
            {field: 'end_date', title: '计费时间到', width: '10%', align: 'center'},
            {field: 'money', title: '费用', width: '9%', align: 'center'},
            {field: 'status', title: '状态', width: '9%', align: 'center'},
            {field: 'info', title: '描述', width: '40%', align: 'center',formatter:function(value){
                if(value){
                    return '<span title='+value+'>'+value+'</span>';
                }
            }}
        ];
        var checkReportName='checkBillStatus';
        var user=[];
        var x=window.location.search;
        var the_param=x.split('=')[1];

        $(function(){           
            for(var i=0;i<user_defined_combobox.length;i++){
                $('#'+user_defined_combobox[i].id).combobox({
                    data:user_defined_combobox[i].data,
                    valueField:'name',
                    textField:'name',
                    panelHeight:'auto'
                })
            }
            var firstDate = new Date();
            firstDate.setDate(1);
            var endDate = new Date(firstDate);
            endDate.setMonth(firstDate.getMonth()+1);
            endDate.setDate(0);
            $('#st_date').datebox('setValue',firstDate.format('yyyy-MM-dd'))
            $('#ed_date').datebox('setValue',endDate.format('yyyy-MM-dd'))
            tssJS.getJSON('/tss/auth/user/has',{},function(data){user = data;query();},'get');
            // tssJS.getJSON(BASE_JSON_URL + reportName + "?noCache=true",{all_type:'历史补贴,'},function(data){
            //     console.log(data)
            // })
            
        })

        function query(){
            dg = $('#t1').datagrid({
                url: record_urls(recordId).QUERY,
                queryParams: getParams(),
                toolbar:'#tb',
                pageList:[100,300,500,1000],
                pageSize : 100,
                fit: true,
                fitColumns: true,
                pagination: true,
                rownumbers: true,
                checkOnSelect: true,
                selectOnCheck: true,
                columns: [column],
            })
        }

        function batchCheck(type){
            if(type == 'pay'){
                var cz_type,status,result_data=['id,status'];
                var data = dg.datagrid('getSelections');
                if(data.length==0){
                    alert('','没有选中的数据！')
                    return
                }
                else{
                    for(var i=0;i<data.length;i++){
                        if(data[i].status != '待支付'){
                            $.messager.alert('提示','无法对非待支付的数据进行支付，请核实选中数据状态！');
                            return
                        }
                        else{
                            result_data.push(data[i].id+','+'已支付')
                        }
                    }
                }
                $.messager.confirm('确认', '您确定要支付选中的'+data.length+'条账单？' , function(result){
                    result && $.post(record_urls(recordId).CUD, {
                                "csv": result_data.join("\n")
                            },function(cud_data){
                                console.log(cud_data)
                                if(cud_data.errorMsg){
                                    $.messager.show({
                                        title:'提示',
                                        msg:cud_data.errorMsg
                                    })
                                }
                                if(cud_data.created || cud_data.updated) {
                                    $.messager.show({
                                        title: '提示',
                                        msg: '批量处理成功！'
                                    });
                                    $('#t1').datagrid('reload');
                            }
                        })
                })
            }
            else if(type == 'cancel'){
                var data = dg.datagrid('getSelections');
                if(data.length == 0){
                    alert('','没有选中的数据！')
                    return
                }
                else{
                    for(var i=0;i<data.length;i++){
                        if(data[i].status == '已支付'){
                            $.messager.alert('提示','无法对已支付的数据进行作废，请核实选中数据状态！');
                            return
                        }
                    }
                    $.post("/tss/bill/invalid",{json:JSON.stringify(data)},function(data){
                        if(data.errorMsg){
                            $.messager.alert('出错',data.errorMsg);
                        }
                        else{$.messager.alert('提示',data)}
                            $('#t1').datagrid('reload');
                        })
                    
                }
            }
            
        }

        function batchQuery(){
            tssJS.getJSON(BASE_JSON_URL + checkReportName + "?noCache=true",getParams(),function(data){
                console.log(data)
                if(data && data.length){
                    var is_excu = true;
                    for(var i=0;i<data.length;i++){
                        console.log(data)
                        if(data[i].status != '待支付'){
                            is_excu = false;
                            console.log(is_excu)
                            $.messager.alert('提示','无法对非待支付的数据进行支付，请核实查询结果数据状态！');
                            return;
                        }
                        console.log(is_excu)
                    }
                    if(is_excu){
                        $.messager.confirm('确认', '您确定要支付查询到的所有费用？' , function(result){
                            if(result){
                                sqlSave(function(r){if(r && r.step1){ $.messager.alert('提示','本次批量支付'+r.step1+'条数据');query()}},[{"sqlCode": 'batchPay', data: getParams()}])
                            }
                            
                        })
                    }
                    
                }
            })

        }

        function sqlSave(callback,json){
            json.each(function(i,item){
                for( key in item.data ){
                    if( !item.data[key] && item.data[key]!=0 ){
                        json[i].data[key]='';
                    }
                    else{
                        json[i].data[key]+='';
                    }
                }
            });
            var params = { 
                json : JSON.stringify(json),
                recordId : recordId||250,
                ds : "connectionpool"
            };

            tssJS.post("/tss/auth/dml/multi"  , params, callback ) 
        }

        function getParams(){
            var params = {
                the_param : the_param,
                // all_type : all_types[the_param],
                plate_num : $('#plate_num').val(),
                type : $('#type').val(),
                status : $('#status').val(),
                st_date : $('#st_date').val(),
                ed_date : $('#ed_date').val(),
                sd_type : $('#busi_type').val(),
                // account_period : $('#account_period').val(),
                bl_account_period : $('#bl_account_period').val(),
                // start_date : $('#st_date').val(),
                // end_date : $('#ed_date').val(),
                domain : user[12],
                user_code : user[3]
            };
            for(k in params){
                if(!params[k]){
                    delete params[k];
                }
            }
            return params;
        }

        // 获取参数月份最后一天
        function getLastDay(the_date) {
            var date = new Date(the_date);
            var currentMonth = date.getMonth();
            var nextMonth = ++currentMonth;
            var nextMonthFirstDay = new Date(date.getFullYear(), nextMonth, 1);
            var oneDay = 1000 * 60 * 60 * 24;
            return new Date(nextMonthFirstDay - oneDay);
        }
        // 获取参数月第一天
        function getFirstDay(the_date) {
            var date = new Date(the_date);
            date.setDate(1);
            return date;
        }

    </script>

</head>
<body>

    <div id="main" class="easyui-layout" fit="true">
        <div id="dataContainer" data-options="region:'center'" border="false" height="50%">
            <table id="t1" border="false"></table>
        </div>
    </div>

    <div id="tb">
        <div style="padding:5px">
            <label>车牌</label>
            <input id='plate_num' class='easyui-textbox' style="width:80px"/>
            <!-- <label>费用类型</label>
            <input id='type' class='easyui-combobox' style="width:80px"/> -->
            <label>账单时间</label>
            <input id='st_date' class='easyui-datebox' editable=false style="width:100px"/>
            <label> → </label>
            <input id='ed_date' class='easyui-datebox' editable=false style="width:100px"/>
            <label>状态</label>
            <input id='status' class='easyui-combobox' style="width:80px"/>        
            <a href="#" class="easyui-linkbutton" plain="true" iconCls="icon-search" onclick="query()">查询</a>
            <a href="#" class="easyui-linkbutton" plain="true" iconCls="icon-edit" onclick="batchCheck('pay')" style="width:130px">批量支付选中账单</a>
            <a href="#" class="easyui-linkbutton" plain="true" iconCls="icon-edit" onclick="batchCheck('cancel')" style="width:130px">批量作废选中账单</a>
            <a href="#" class="easyui-linkbutton" plain="true" iconCls="icon-edit" onclick="batchQuery()" style="width:130px">批量支付查询结果</a>
    </div>

    <iframe id="downloadFrame" style="display:none"></iframe>
</body>
</html>
</html>